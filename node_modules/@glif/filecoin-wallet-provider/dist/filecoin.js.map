{"version":3,"sources":["../src/filecoin.ts"],"names":["Filecoin","provider","config","apiAddress","address","jsonRpcEngine","request","balance","FilecoinNumber","message","res","signature","Error","signedMessage","Message","Signature","Type","Data","Number","nonce","toLowerCase","includes","clonedMsg","Object","assign","From","networkPrefix","KNOWN_TYPE_0_ADDRESS","KNOWN_TYPE_1_ADDRESS","KNOWN_TYPE_3_ADDRESS","cloneMsgWOnChainFromAddr","feeCap","gasLimit","numBlocksIncluded","GasLimit","gasPremium","maxFee","toAttoFil","MaxFee","To","Value","GasPremium","GasFeeCap","Method","Nonce","Params","toAddressWithCorrectPrefix","slice","to","from","value","gasFeeCap","method","params","gasEstimateMessageGas","msgWithGas","toLotusType","BigNumber","limit","times","baseFee","gasUsed","gasFeeCapBN","gasPremiumBN","gasLimitBN","baseFeeBN","gasUsedBN","gasToBurn","totalGas","plus","minBaseFeeFeeCap","minimum","leftSide","minTip","minus","rightSide","maximum","getReplaceMessageMinGasParams","minGasFeeCap","minGasLimit","minGasPremium","copiedMessage","recommendedGasFeeCap","recommendedGasLimit","recommendedGasPremium","takeMin","newFeeCap","newPremium","multipliedBy","dividedBy","isGreaterThan","toFixed","ROUND_CEIL","wallet","LotusRpcEngine"],"mappings":"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","sourcesContent":["import LotusRpcEngine, { LotusRpcEngineConfig } from '@glif/filecoin-rpc-client'\nimport { FilecoinNumber } from '@glif/filecoin-number'\nimport { checkAddressString, Network } from '@glif/filecoin-address'\nimport { LotusMessage, Message } from '@glif/filecoin-message'\nimport {\n  computeGasToBurn,\n  KNOWN_TYPE_0_ADDRESS,\n  KNOWN_TYPE_1_ADDRESS,\n  KNOWN_TYPE_3_ADDRESS,\n  allCallsExitWithCode0,\n} from './utils'\nimport { BigNumber } from 'bignumber.js'\nimport { WalletSubProvider } from './wallet-sub-provider'\nimport { InvocResult, CID } from './types'\nimport { num1GreaterThanNum2 } from './utils'\n\nexport class Filecoin {\n  public wallet: WalletSubProvider\n  public jsonRpcEngine: LotusRpcEngine\n\n  constructor(\n    provider: WalletSubProvider,\n    config: LotusRpcEngineConfig = {\n      apiAddress: 'http://127.0.0.1:1234/rpc/v0',\n    },\n  ) {\n    if (!provider) throw new Error('No provider provided.')\n    this.wallet = provider\n    this.jsonRpcEngine = new LotusRpcEngine(config)\n  }\n\n  getBalance = async (address: string): Promise<FilecoinNumber> => {\n    checkAddressString(address)\n    const balance = await this.jsonRpcEngine.request<string>(\n      'WalletBalance',\n      address,\n    )\n    return new FilecoinNumber(balance, 'attofil')\n  }\n\n  simulateMessage = async (message: LotusMessage): Promise<boolean> => {\n    const res = await this.jsonRpcEngine.request<InvocResult>(\n      'StateCall',\n      message,\n      null,\n    )\n    return allCallsExitWithCode0(res)\n  }\n\n  sendMessage = async (\n    message: LotusMessage,\n    signature: string,\n  ): Promise<CID> => {\n    if (!message) throw new Error('No message provided.')\n    if (!signature) throw new Error('No signature provided.')\n    const signedMessage = {\n      Message: message,\n      Signature: {\n        // wallet only supports secp256k1 keys for now\n        Type: 1,\n        Data: signature,\n      },\n    }\n\n    return this.jsonRpcEngine.request<{ '/': string }>(\n      'MpoolPush',\n      signedMessage,\n    )\n  }\n\n  getNonce = async (address: string): Promise<number> => {\n    if (!address) throw new Error('No address provided.')\n    checkAddressString(address)\n    try {\n      const nonce = Number(\n        await this.jsonRpcEngine.request('MpoolGetNonce', address),\n      )\n      return nonce\n    } catch (err) {\n      if (\n        err &&\n        err.message &&\n        err.message.toLowerCase().includes('actor not found')\n      )\n        return 0\n      throw new Error(err)\n    }\n  }\n\n  cloneMsgWOnChainFromAddr = async (\n    message: LotusMessage,\n  ): Promise<LotusMessage> => {\n    const clonedMsg = Object.assign({}, message)\n    try {\n      // state call errs if the from address does not exist on chain yet, lookup from actor ID to know this for sure\n      await this.jsonRpcEngine.request('StateLookupID', clonedMsg.From, null)\n    } catch (err) {\n      // if from actor doesnt exist, use a hardcoded known actor address\n      if (err.message.toLowerCase().includes('actor not found')) {\n        const networkPrefix = clonedMsg.From[0] as Network\n\n        if (!clonedMsg.From)\n          clonedMsg.From = KNOWN_TYPE_0_ADDRESS[networkPrefix]\n        if (clonedMsg.From[1] === '0')\n          clonedMsg.From = KNOWN_TYPE_0_ADDRESS[networkPrefix]\n        else if (clonedMsg.From[1] === '1')\n          clonedMsg.From = KNOWN_TYPE_1_ADDRESS[networkPrefix]\n        else if (clonedMsg.From[1] === '3')\n          clonedMsg.From = KNOWN_TYPE_3_ADDRESS[networkPrefix]\n        else {\n          // this should never happen, only t1 and t3 addresses can be used as a from?\n          clonedMsg.From = KNOWN_TYPE_0_ADDRESS[networkPrefix]\n        }\n      }\n    }\n    return clonedMsg\n  }\n\n  gasEstimateFeeCap = async (\n    message: LotusMessage,\n  ): Promise<FilecoinNumber> => {\n    if (!message) throw new Error('No message provided.')\n    const clonedMsg = await this.cloneMsgWOnChainFromAddr(message)\n    const feeCap = await this.jsonRpcEngine.request<string>(\n      'GasEstimateFeeCap',\n      clonedMsg,\n      0,\n      null,\n    )\n\n    return new FilecoinNumber(feeCap, 'attofil')\n  }\n\n  gasEstimateGasLimit = async (\n    message: LotusMessage,\n  ): Promise<FilecoinNumber> => {\n    if (!message) throw new Error('No message provided.')\n    const clonedMsg = await this.cloneMsgWOnChainFromAddr(message)\n\n    const gasLimit = await this.jsonRpcEngine.request<string>(\n      'GasEstimateGasLimit',\n      clonedMsg,\n      null,\n    )\n\n    return new FilecoinNumber(gasLimit, 'attofil')\n  }\n\n  gasEstimateGasPremium = async (\n    message: LotusMessage,\n    numBlocksIncluded: number = 0,\n  ): Promise<FilecoinNumber> => {\n    if (!message) throw new Error('No message provided.')\n    const clonedMsg = await this.cloneMsgWOnChainFromAddr(message)\n\n    const gasPremium = await this.jsonRpcEngine.request<string>(\n      'GasEstimateGasPremium',\n      numBlocksIncluded,\n      clonedMsg.From,\n      clonedMsg.GasLimit || 0,\n      null,\n    )\n\n    return new FilecoinNumber(gasPremium, 'attofil')\n  }\n\n  gasEstimateMessageGas = async (\n    message: LotusMessage,\n    maxFee: string = new FilecoinNumber('0.1', 'fil').toAttoFil(),\n  ): Promise<Message> => {\n    if (!message) throw new Error('No message provided.')\n    const clonedMsg = await this.cloneMsgWOnChainFromAddr(message)\n    const {\n      To,\n      Value,\n      GasPremium,\n      GasFeeCap,\n      GasLimit,\n      Method,\n      Nonce,\n      Params,\n    } = await this.jsonRpcEngine.request(\n      'GasEstimateMessageGas',\n      clonedMsg,\n      { MaxFee: maxFee },\n      null,\n    )\n\n    // this is a hack to get by weird UI bugs where f addresses convert to t addresses\n    const toAddressWithCorrectPrefix = clonedMsg.To[0] + To.slice(1)\n    return new Message({\n      to: toAddressWithCorrectPrefix,\n      from: message.From,\n      value: Value,\n      gasPremium: GasPremium,\n      gasFeeCap: GasFeeCap,\n      gasLimit: GasLimit,\n      method: Method,\n      nonce: Nonce,\n      params: Params,\n    })\n  }\n\n  gasEstimateMaxFee = async (\n    message: LotusMessage,\n  ): Promise<{ maxFee: FilecoinNumber; message: LotusMessage }> => {\n    const msgWithGas = (await this.gasEstimateMessageGas(message)).toLotusType()\n    const feeCap = new BigNumber(msgWithGas.GasFeeCap)\n    const limit = new BigNumber(msgWithGas.GasLimit)\n    return {\n      maxFee: new FilecoinNumber(feeCap.times(limit), 'attofil'),\n      message: msgWithGas,\n    }\n  }\n\n  /**\n   * formula (some of these variable names might not be the best...):\n   * (GasUsed+GasToBurn)*min(BaseFee, FeeCap)+GasLimit*max(0, min(FeeCap-BaseFee, GasPremium)))\n   *\n   * minBaseFeeFeeCap = min(BaseFee, FeeCap)\n   * totalGas = GasUsed+GasToBurn\n   * leftSide = totalGas*minBaseFeeFeeCap\n   *\n   * minTip = min(FeeCap-BaseFee, GasPremium)\n   * rightSide = gasLimit*max(0, minTip)\n   *\n   * paidByMessageSender =\n   * leftSide + rightSide\n   */\n  gasCalcTxFee = async (\n    gasFeeCap: string,\n    gasPremium: string,\n    gasLimit: number,\n    baseFee: string,\n    gasUsed: string,\n  ): Promise<FilecoinNumber> => {\n    const gasFeeCapBN = new BigNumber(gasFeeCap)\n    const gasPremiumBN = new BigNumber(gasPremium)\n    const gasLimitBN = new BigNumber(gasLimit)\n    const baseFeeBN = new BigNumber(baseFee)\n    const gasUsedBN = new BigNumber(gasUsed)\n\n    /* compute left side */\n    const gasToBurn = computeGasToBurn(gasUsedBN, gasLimitBN)\n    const totalGas = gasUsedBN.plus(gasToBurn)\n    const minBaseFeeFeeCap = BigNumber.minimum(baseFeeBN, gasFeeCapBN)\n    const leftSide = totalGas.times(minBaseFeeFeeCap)\n\n    /* compute right side */\n    const minTip = BigNumber.minimum(gasFeeCapBN.minus(baseFeeBN), gasPremiumBN)\n    const rightSide = gasLimitBN.times(BigNumber.maximum(0, minTip))\n\n    return new FilecoinNumber(leftSide.plus(rightSide), 'attofil')\n  }\n\n  /*\n   * Used for calculating gas params of replaced messages\n   * To get the params - we compare the minimum bump in gas (gas premium * 1.25)\n   * against the recommended gas params (taken from gasEstimateMessageGas, maxFee = .1)\n   *\n   * If any of the 3 gas params in the recommended gas amounts are LESS\n   * than the params calculated in the minimum bump in gas, take the minimum bump in gas\n   *\n   */\n\n  getReplaceMessageGasParams = async (\n    message: LotusMessage,\n    maxFee: string = new FilecoinNumber('0.1', 'fil').toAttoFil(),\n  ): Promise<{ gasFeeCap: string; gasPremium: string; gasLimit: number }> => {\n    const {\n      gasFeeCap: minGasFeeCap,\n      gasLimit: minGasLimit,\n      gasPremium: minGasPremium,\n    } = await this.getReplaceMessageMinGasParams(message)\n\n    const copiedMessage = { ...message }\n    copiedMessage.GasFeeCap = '0'\n    copiedMessage.GasPremium = '0'\n    copiedMessage.GasLimit = 0\n    const {\n      GasFeeCap: recommendedGasFeeCap,\n      GasLimit: recommendedGasLimit,\n      GasPremium: recommendedGasPremium,\n    } = (await this.gasEstimateMessageGas(copiedMessage, maxFee)).toLotusType()\n\n    // assume we take the recommended prices\n    let takeMin = false\n\n    // if any of the minimum amounts are greater than the recommended,\n    // take the minimum amounts\n    if (num1GreaterThanNum2(minGasFeeCap, recommendedGasFeeCap)) takeMin = true\n    if (num1GreaterThanNum2(minGasLimit, recommendedGasLimit)) takeMin = true\n    if (num1GreaterThanNum2(minGasPremium, recommendedGasPremium))\n      takeMin = true\n\n    if (takeMin) {\n      return {\n        gasFeeCap: minGasFeeCap,\n        gasLimit: minGasLimit,\n        gasPremium: minGasPremium,\n      }\n    }\n    return {\n      gasFeeCap: recommendedGasFeeCap,\n      gasLimit: recommendedGasLimit,\n      gasPremium: recommendedGasPremium,\n    }\n  }\n\n  /**\n   * Used for calculating the minimum boost in gas params to replace a message\n   *  (1.25x prev gasPremium, bump fee cap as needed)\n   */\n  getReplaceMessageMinGasParams = async (\n    message: LotusMessage,\n  ): Promise<{ gasFeeCap: string; gasPremium: string; gasLimit: number }> => {\n    let newFeeCap = message.GasFeeCap\n    const newPremium = new BigNumber(message.GasPremium)\n      .multipliedBy(125)\n      .dividedBy(100)\n\n    if (newPremium.isGreaterThan(message.GasFeeCap)) {\n      newFeeCap = newPremium.toFixed(0, BigNumber.ROUND_CEIL)\n    }\n\n    return {\n      gasFeeCap: newFeeCap,\n      gasPremium: newPremium.toFixed(0, BigNumber.ROUND_CEIL),\n      gasLimit: message.GasLimit,\n    }\n  }\n}\n"],"file":"filecoin.js"}